<div class="modal fade" id="reviewModal" tabindex="-1" aria-labelledby="reviewModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">

      <!-- Header -->
      <div class="modal-header">
        <h5 class="modal-title" id="reviewModalLabel">Add a Review</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <!-- Body -->
      <div class="modal-body">
        <form id="reviewForm" method="POST" action="" data-venue="{{ venue.id }}">
          {% csrf_token %}
          <input type="hidden" name="venue" value="{{ venue.id }}">

          <!-- ACCESSIBILITY -->
          <div class="mb-3">
            <label class="form-label">Accessibility</label>
            <div class="star-rating" data-target="id_accessibility">
              {% for i in "12345" %}
                <span class="star" data-value="{{ i }}">&#9733;</span>
              {% endfor %}
            </div>
            <select name="accessibility" id="id_accessibility" required class="visually-hidden">>
              <option value="">-</option>
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4</option>
              <option value="5">5</option>
            </select>
          </div>

          <!-- FACILITY -->
          <div class="mb-3">
            <label class="form-label">Facility</label>
            <div class="star-rating" data-target="id_facility">
              {% for i in "12345" %}
                <span class="star" data-value="{{ i }}">&#9733;</span>
              {% endfor %}
            </div>
            <select name="facility" id="id_facility" required class="visually-hidden">
              <option value="">-</option>
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4</option>
              <option value="5">5</option>
            </select>
          </div>

          <!-- VALUE FOR MONEY -->
          <div class="mb-3">
            <label class="form-label">Value for money</label>
            <div class="star-rating" data-target="id_value_for_money">
              {% for i in "12345" %}
                <span class="star" data-value="{{ i }}">&#9733;</span>
              {% endfor %}
            </div>
            <select name="value_for_money" id="id_value_for_money" required class="visually-hidden">
              <option value="">-</option>
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4</option>
              <option value="5">5</option>
            </select>
          </div>

          <!-- COMMENT -->
          <div class="mb-3">
            <label for="id_comment" class="form-label">Comment</label>
            <textarea name="comment" id="id_comment" class="form-control" rows="4"></textarea>
          </div>
        </form>
      </div>

      <!-- Footer -->
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" form="reviewForm" class="btn btn-success" id="submitReviewBtn">Publish Review</button>
      </div>

    </div>
  </div>
</div>

<style>
.star-rating { display: inline-block; }
.star { font-size: 28px; color: #ccc; cursor: pointer; transition: color 0.2s; }
.star:hover { color: #ffd700; }
.star.selected { color: gold; }

.visually-hidden {
  position: absolute !important;
  width: 1px; height: 1px;
  padding: 0; margin: -1px;
  overflow: hidden;
  clip: rect(0, 0, 0, 0);
  border: 0;
}
</style>
<script>
document.addEventListener("DOMContentLoaded", function () {

    /* ---------- INIT STAR RATINGS ---------- */
    function initStarRatings() {
        document.querySelectorAll(".star-rating").forEach(rating => {
            const select = document.getElementById(rating.dataset.target);
            if (!select) return;

            rating.querySelectorAll(".star").forEach(star => {
                // Remove existing listeners by cloning
                const newStar = star.cloneNode(true);
                star.parentNode.replaceChild(newStar, star);

                newStar.addEventListener("click", function () {
                    const val = this.dataset.value;
                    select.value = val;

                    // Update visual stars
                    rating.querySelectorAll(".star").forEach(s => s.classList.remove("selected"));
                    rating.querySelectorAll(".star").forEach(s => {
                        if (parseInt(s.dataset.value) <= parseInt(val)) {
                            s.classList.add("selected");
                        }
                    });
                });
            });
        });
    }

    initStarRatings();

    /* ---------- RESET MODAL TO ADD MODE ---------- */
    function resetModalToAddMode() {
        const form = document.getElementById("reviewForm");
        const venueId = form.dataset.venue;
        
        form.action = `/review/add_review_ajax/${venueId}/`;
        form.reset();
        
        document.querySelectorAll(".star").forEach(s => s.classList.remove("selected"));
        document.getElementById("reviewModalLabel").innerText = "Add a Review";
        document.getElementById("submitReviewBtn").innerText = "Publish Review";
    }

    /* ---------- RELOAD REVIEWS + REATTACH LISTENERS ---------- */
    function reloadReviews(venueId) {
        fetch(`/venue/${venueId}/reviews_html/`)
            .then(r => r.json())
            .then(htmlData => {
                const parser = new DOMParser();
                const doc = parser.parseFromString(htmlData.html, "text/html");
                const newContainer = doc.querySelector("#reviewsContainer");
                
                if (newContainer) {
                    document.getElementById("reviewsContainer").outerHTML = newContainer.outerHTML;
                    attachReviewButtons(); // CRITICAL: reattach event listeners
                }
            })
            .catch(err => console.error("Error reloading reviews:", err));
    }

    /* ---------- AJAX SUBMIT ---------- */
    document.getElementById("reviewForm").addEventListener("submit", function (e) {
        console.log("submit CLICKED");
        e.preventDefault();

        const form = this;
        const formData = new FormData(form);

         const isEditMode = form.action.includes('edit_review_ajax');

        fetch(form.action, {
            method: "POST",
            body: formData,
            headers: { 
                "X-Requested-With": "XMLHttpRequest",
                "X-CSRFToken": formData.get("csrfmiddlewaretoken")
            }
        })
        .then(r => r.json())
        .then(data => {
            if (!data.success) {
                showMessage("Errors: " + JSON.stringify(data.error), "danger");
                console.error("Form errors:", data.error);
                return;
            }

            // Success: fermeture forcée et nettoyage complet du modal
            const modalElement = document.getElementById("reviewModal");
            
            // Fermer le modal
            modalElement.classList.remove('show');
            modalElement.setAttribute('aria-hidden', 'true');
            modalElement.setAttribute('style', 'display: none');
            
            // Nettoyer le backdrop (voile gris)
            const backdrops = document.querySelectorAll('.modal-backdrop');
            backdrops.forEach(backdrop => backdrop.remove());
            
            // Nettoyer le body
            document.body.classList.remove('modal-open');
            document.body.style.removeProperty('overflow');
            document.body.style.removeProperty('padding-right');
            
            resetModalToAddMode();
            reloadReviews(data.venue_id || form.dataset.venue);

            // Afficher le message de succès approprié
        if (isEditMode) {
            showMessage("Your review has been updated successfully!", "success");
        } else {
            showMessage("Your review has been added successfully!", "success");
        }
        })
        .catch(err => {
            console.error("AJAX error:", err);
            showMessage("An error occurred. Please try again.", "danger");
        });
    });

    /* ---------- OPEN ADD REVIEW ---------- */
    document.getElementById("openAddReviewBtn").addEventListener("click", () => {
    // Vérifier si l'utilisateur a déjà posté une review
    const currentUsername = "{{ user.username }}"; // Récupérer le username de l'utilisateur connecté
    const reviewsContainer = document.getElementById("reviewsContainer");
    
    // Chercher si une review de cet utilisateur existe déjà
    const userReviews = reviewsContainer.querySelectorAll("strong");
    let hasReviewed = false;

    userReviews.forEach(usernameElement => {
        if (usernameElement.textContent.trim() === currentUsername) {
            hasReviewed = true;
        }
    });
    
    if (hasReviewed) {
        showMessage("You've already reviewed this venue. You can edit or delete your existing review.", "warning");
        return; 
    }
    
    // Si pas de review existante, ouvrir le modal en mode "Add"
    resetModalToAddMode();
    const modal = new bootstrap.Modal(document.getElementById("reviewModal"));
    modal.show();
});

    /* ---------- ATTACH REVIEW BUTTONS (Edit/Delete) ---------- */
    function attachReviewButtons() {
        // EDIT buttons
        document.querySelectorAll(".editReviewBtn").forEach(btn => {
            // Clone to remove ALL old listeners
            const newBtn = btn.cloneNode(true);
            btn.parentNode.replaceChild(newBtn, btn);
        });

        document.querySelectorAll(".editReviewBtn").forEach(btn => {
            btn.addEventListener("click", function(e) {
                e.preventDefault(); // Empêche tout comportement par défaut
                e.stopPropagation(); // Empêche la propagation de l'événement
                
                console.log("EDIT CLICKED", this.dataset.id);
                const form = document.getElementById("reviewForm");
                
                // Set form action for editing
                form.action = this.dataset.url;

                // Fill form values
                document.getElementById("id_accessibility").value = this.dataset.accessibility;
                document.getElementById("id_facility").value = this.dataset.facility;
                document.getElementById("id_value_for_money").value = this.dataset.vfm;
                document.getElementById("id_comment").value = this.dataset.comment;

                // Update stars visually
                document.querySelectorAll(".star-rating").forEach(rating => {
                    const select = document.getElementById(rating.dataset.target);
                    const val = parseInt(select.value);

                    rating.querySelectorAll(".star").forEach(s => s.classList.remove("selected"));
                    rating.querySelectorAll(".star").forEach(star => {
                        if (parseInt(star.dataset.value) <= val) {
                            star.classList.add("selected");
                        }
                    });
                });

                // Update modal title
                document.getElementById("reviewModalLabel").innerText = "Edit Review";
                document.getElementById("submitReviewBtn").innerText = "Save Changes";

                // Show modal
                const modal = new bootstrap.Modal(document.getElementById("reviewModal"));
                modal.show();
            });
        });

        // DELETE buttons
        document.querySelectorAll(".deleteReviewBtn").forEach(btn => {
            const newBtn = btn.cloneNode(true);
            btn.parentNode.replaceChild(newBtn, btn);
        });

        document.querySelectorAll(".deleteReviewBtn").forEach(btn => {
            btn.addEventListener("click", function(e) {
                e.preventDefault(); // Empêche tout comportement par défaut
                e.stopPropagation(); // Empêche la propagation de l'événement
                
                console.log("DELETE CLICKED", this.dataset.id);
                
                if (!confirm("Are you sure you want to delete this review?")) {
                    return; // L'utilisateur a annulé
                }
                
                fetch(this.dataset.url, {
                    method: "POST",
                    headers: {
                        "X-Requested-With": "XMLHttpRequest",
                        "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value
                    }
                })
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        const venueId = document.getElementById("reviewForm").dataset.venue;
                        reloadReviews(venueId);
                    showMessage("Your review has been deleted successfully!", "success");
                } else {
                    showMessage("Error: " + JSON.stringify(data.error), "danger");
                }
                })
                .catch(err => {
                    showMessage("Delete error: " + err, "danger");
                    console.error("Delete error:", err);
                });
            });
        });
    }

    // Initial attach
    attachReviewButtons();

});

/* ---------- FUNCTION TO SHOW DJANGO-STYLE MESSAGES ---------- */
function showMessage(text, type = "info") {
    // Types possibles: success, info, warning, error, danger
    const messagesContainer = document.querySelector(".messages") || createMessagesContainer();
    
    const messageDiv = document.createElement("div");
    messageDiv.className = `alert alert-${type} alert-dismissible fade show`;
    messageDiv.role = "alert";
    messageDiv.innerHTML = `
        ${text}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;
    
    messagesContainer.appendChild(messageDiv);
    
    // Auto-remove après 5 secondes
    setTimeout(() => {
      messageDiv.classList.remove('show');
        setTimeout(() => messageDiv.remove(), 150);
    }, 5000);
}

function createMessagesContainer() {
    const container = document.createElement("div");
    container.className = "messages";
    container.style.cssText = "position: fixed; top: 20px; right: 20px; z-index: 9999; max-width: 400px;";
    document.body.appendChild(container);
    return container;
}
</script>