{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
  <h2>Add a Review</h2>
  <p class="text-muted">Select a venue and share your experience</p>

  <!-- Messages container for AJAX feedback -->
  <div class="messages"></div>

  <form id="generalReviewForm" method="POST">
    {% csrf_token %}

    <!-- VENUE SELECTION -->
    <div class="mb-3">
      <label for="id_venue" class="form-label">Select Venue *</label>
      <select name="venue" id="id_venue" class="form-control" required>
        <option value="">-- Choose a venue --</option>
        {% for venue in venues %}
          <option value="{{ venue.id }}">{{ venue.name }} - {{ venue.CityName }}</option>
        {% endfor %}
      </select>
    </div>

    <!-- ACCESSIBILITY -->
    <div class="mb-3">
      <label class="form-label">Accessibility *</label>
      <div class="star-rating" data-target="id_accessibility">
        {% for i in "12345" %}
          <span class="star" data-value="{{ i }}">&#9733;</span>
        {% endfor %}
      </div>
      <select name="accessibility" id="id_accessibility" required class="visually-hidden">
        <option value="">-</option>
        <option value="1">1</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5</option>
      </select>
    </div>

    <!-- FACILITY -->
    <div class="mb-3">
      <label class="form-label">Facility *</label>
      <div class="star-rating" data-target="id_facility">
        {% for i in "12345" %}
          <span class="star" data-value="{{ i }}">&#9733;</span>
        {% endfor %}
      </div>
      <select name="facility" id="id_facility" required class="visually-hidden">
        <option value="">-</option>
        <option value="1">1</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5</option>
      </select>
    </div>

    <!-- VALUE FOR MONEY -->
    <div class="mb-3">
      <label class="form-label">Value for Money *</label>
      <div class="star-rating" data-target="id_value_for_money">
        {% for i in "12345" %}
          <span class="star" data-value="{{ i }}">&#9733;</span>
        {% endfor %}
      </div>
      <select name="value_for_money" id="id_value_for_money" required class="visually-hidden">
        <option value="">-</option>
        <option value="1">1</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5</option>
      </select>
    </div>

    <!-- COMMENT -->
    <div class="mb-3">
      <label for="id_comment" class="form-label">Comment</label>
      <textarea name="comment" id="id_comment" class="form-control" rows="4" placeholder="Share your experience..."></textarea>
    </div>

    <div class="mb-3">
      <button type="submit" class="btn btn-success">Publish Review</button>
      <a href="{% url 'main:show_main' %}" class="btn btn-secondary">Cancel</a>
    </div>
  </form>
</div>

<style>
.star-rating { display: inline-block; }
.star { 
  font-size: 28px; 
  color: #ccc; 
  cursor: pointer; 
  transition: color 0.2s; 
}
.star:hover { color: #ffd700; }
.star.selected { color: gold; }

.visually-hidden {
  position: absolute !important;
  width: 1px; 
  height: 1px;
  padding: 0; 
  margin: -1px;
  overflow: hidden;
  clip: rect(0, 0, 0, 0);
  border: 0;
}

.messages {
  position: fixed;
  top: 20px;
  right: 20px;
  z-index: 9999;
  max-width: 400px;
}
</style>

<script>
document.addEventListener("DOMContentLoaded", function () {

  /* ---------- INIT STAR RATINGS ---------- */
  function initStarRatings() {
    document.querySelectorAll(".star-rating").forEach(rating => {
      const select = document.getElementById(rating.dataset.target);
      if (!select) return;

      rating.querySelectorAll(".star").forEach(star => {
        star.addEventListener("click", function () {
          const val = this.dataset.value;
          select.value = val;

          // Update visual stars
          rating.querySelectorAll(".star").forEach(s => s.classList.remove("selected"));
          rating.querySelectorAll(".star").forEach(s => {
            if (parseInt(s.dataset.value) <= parseInt(val)) {
              s.classList.add("selected");
            }
          });
        });
      });
    });
  }

  initStarRatings();

  /* ---------- AJAX SUBMIT ---------- */
  document.getElementById("generalReviewForm").addEventListener("submit", function (e) {
    e.preventDefault();

    const form = this;
    const formData = new FormData(form);
    const venueId = formData.get("venue");

    if (!venueId) {
      showMessage("Please select a venue", "warning");
      return;
    }

    // Check if all ratings are filled
    if (!formData.get("accessibility") || !formData.get("facility") || !formData.get("value_for_money")) {
      showMessage("Please rate all criteria", "warning");
      return;
    }

    fetch(`/review/add_review_ajax/${venueId}/`, {
      method: "POST",
      body: formData,
      headers: { 
        "X-Requested-With": "XMLHttpRequest",
        "X-CSRFToken": formData.get("csrfmiddlewaretoken")
      }
    })
    .then(r => r.json())
    .then(data => {
      if (!data.success) {
        showMessage("Error: " + JSON.stringify(data.error), "danger");
        console.error("Form errors:", data.error);
        return;
      }

      // Success
      showMessage("Your review has been added successfully!", "success");
      
      // Reset form
      form.reset();
      document.querySelectorAll(".star").forEach(s => s.classList.remove("selected"));

      // Optional: redirect to venue page after 2 seconds
      setTimeout(() => {
        window.location.href = `/venue/${venueId}/`;
      }, 2000);
    })
    .catch(err => {
      console.error("AJAX error:", err);
      showMessage("An error occurred. Please try again.", "danger");
    });
  });

});

/* ---------- FUNCTION TO SHOW MESSAGES ---------- */
function showMessage(text, type = "info") {
  const messagesContainer = document.querySelector(".messages");
  
  const messageDiv = document.createElement("div");
  messageDiv.className = `alert alert-${type} alert-dismissible fade show`;
  messageDiv.role = "alert";
  messageDiv.innerHTML = `
    ${text}
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  `;
  
  messagesContainer.appendChild(messageDiv);
  
  // Auto-remove after 5 seconds
  setTimeout(() => {
    messageDiv.classList.remove('show');
    setTimeout(() => messageDiv.remove(), 150);
  }, 5000);
}
</script>

{% endblock content %}