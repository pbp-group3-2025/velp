{% extends 'base.html' %}
{% load humanize %}
{% block content %}
<h1>Booking Detail</h1>
<p>Venue: {{ booking.venue.name }}</p>
<p>Date: {{ booking.date }}</p>
<p>Time: {{ booking.start_time }} — {{ booking.end_time }}</p>
<p>Duration: {{ booking.duration_hours }} hour(s)</p>
<p>Payment: {{ booking.get_payment_method_display }}</p>
<p>Total: Rp {{ booking.total_price|intcomma }}</p>
<p>Status: {{ booking.get_status_display }}</p>

{% if booking.status == "PENDING" %}
<form method="post">
  {% csrf_token %}
  <button type="submit">Confirm Booking</button>
</form>

<div id="ajax-message"></div>
{% endif %}

<p><a href="{% url 'main:booking_list' %}">← Back to my bookings</a></p>
{% endblock %}

function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(";").shift();
}

document.addEventListener("DOMContentLoaded", function () {

    document.addEventListener("submit", async function (e) {
        const form = e.target;

        // Only target forms with AJAX
        if (!form.matches(".ajax-form")) return;

        e.preventDefault();

        const action = form.action;
        const csrftoken = getCookie("csrftoken");

        const btn = form.querySelector("button[type=submit]");
        if (btn) {
            btn.disabled = true;
            btn.dataset.originalText = btn.innerText;
            btn.innerText = "Processing...";
        }

        try {
            const resp = await fetch(action, {
                method: "POST",
                headers: {
                    "X-Requested-With": "XMLHttpRequest",
                    "X-CSRFToken": csrftoken
                }
            });

            const data = await resp.json();

            if (resp.ok && data.ok) {
                // If this is cancel inside list
                if (form.classList.contains("cancel-inline")) {
                    const li = form.closest("li");
                    if (li) {
                        li.querySelector("button[type=submit]").innerText = "Cancelled";
                    }
                    return;
                }

                // If this is confirm on detail page
                if (data.message) {
                    window.location.href = "/booking/list/";
                    return;
                }
            } else {
                alert("Something went wrong: " + (data.message || ""));
            }

        } catch (err) {
            alert("Network error: " + err.message);
        } finally {
            if (btn) {
                btn.disabled = false;
                btn.innerText = btn.dataset.originalText;
            }
        }
    });
});
