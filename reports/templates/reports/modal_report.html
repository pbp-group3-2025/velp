<!-- Trigger example (create) anywhere -->
<button type="button"
        class="btn btn-primary"
        data-open-report
        data-target-type="venue"
        data-object-id="{{ venue.id }}"
        data-bs-toggle="modal"
        data-bs-target="#reportModal">
  Report content
</button>

<!-- templates/reports/report_modal.html -->
<div class="modal fade" id="reportModal" tabindex="-1" aria-labelledby="reportModalTitle" aria-hidden="true" data-bs-backdrop="static">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title" id="reportModalTitle">Report content</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <form id="reportForm" method="POST" action="{% url 'reports:create' %}">
        {% csrf_token %}

        <!-- mode + target -->
        <input type="hidden" id="report-mode" value="create"> <!-- 'create' or 'edit' -->
        <input type="hidden" name="object_id" id="report-object-id">
        <input type="hidden" name="target_type" id="report-target-type">

        <div class="modal-body">
          <div class="mb-3">
            <label for="report-reason" class="form-label">Reason</label>
            <select name="reason" id="report-reason" required class="form-select">
              <option value="inappropriate">Inappropriate / Harassment</option>
              <option value="spam">Spam / Ads</option>
              <option value="false_info">False or Misleading Info</option>
              <option value="scam">Scam / Fraud</option>
              <option value="other">Other</option>
            </select>
          </div>

          <div class="mb-3">
            <label for="report-details" class="form-label">Details (optional)</label>
            <textarea name="details" id="report-details" rows="4" class="form-control" placeholder="Add context or evidence..."></textarea>
          </div>

          <p id="reportFeedback" class="small d-none mb-0"></p>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary" id="reportSubmitBtn">Submit</button>
        </div>
      </form>

    </div>
  </div>
</div>

<script>
// CSRF helper
function getCookie(name) {
  const value = `; ${document.cookie}`;
  const parts = value.split(`; ${name}=`);
  if (parts.length === 2) return decodeURIComponent(parts.pop().split(';').shift());
}
const csrftoken = getCookie('csrftoken');

const modalEl      = document.getElementById('reportModal');
const formEl       = document.getElementById('reportForm');
const feedbackEl   = document.getElementById('reportFeedback');
const submitBtnEl  = document.getElementById('reportSubmitBtn');

const modeEl       = document.getElementById('report-mode');
const titleEl      = document.getElementById('reportModalTitle');

const objectIdEl   = document.getElementById('report-object-id');
const targetTypeEl = document.getElementById('report-target-type');

const reasonEl     = document.getElementById('report-reason');
const detailsEl    = document.getElementById('report-details');

// Populate modal when it's about to be shown
modalEl.addEventListener('show.bs.modal', (evt) => {
  const btn = evt.relatedTarget;
  if (!btn) return;

  feedbackEl.classList.add('d-none');
  feedbackEl.textContent = '';

  // EDIT mode button has data-edit-report; CREATE has data-open-report
  if (btn.hasAttribute('data-edit-report')) {
    modeEl.value = 'edit';
    titleEl.textContent = 'Edit your report';
    formEl.action = btn.dataset.reportAction; // e.g. /report/update/<id>/

    // Not needed in edit (ignored by view), keep blank
    objectIdEl.value = '';
    targetTypeEl.value = '';

    // Prefill
    reasonEl.value  = btn.dataset.reportReason || 'inappropriate';
    detailsEl.value = btn.dataset.reportDetails || '';

    submitBtnEl.textContent = 'Save Changes';
  } else {
    modeEl.value = 'create';
    titleEl.textContent = 'Report content';
    formEl.action = "{% url 'reports:create' %}";

    // Filled from opener
    objectIdEl.value   = btn.dataset.objectId || '';
    targetTypeEl.value = btn.dataset.targetType || '';

    reasonEl.value  = 'inappropriate';
    detailsEl.value = '';
    submitBtnEl.textContent = 'Submit';
  }
});

// Optional: reset form when closed
modalEl.addEventListener('hidden.bs.modal', () => {
  formEl.reset();
  feedbackEl.classList.add('d-none');
  feedbackEl.textContent = '';
});

// Submit (works for both create & edit)
formEl.addEventListener('submit', async (e) => {
  e.preventDefault();
  submitBtnEl.disabled = true;

  try {
    const res = await fetch(formEl.action, {
      method: 'POST',
      headers: { 'X-CSRFToken': csrftoken },
      body: new FormData(formEl),
    });

    // update_report returns JSON, create_report returns JSON â€” good
    const data = await res.json();

    feedbackEl.classList.remove('d-none');
    if (res.ok && data.ok) {
      feedbackEl.classList.remove('text-danger');
      feedbackEl.classList.add('text-success');
      feedbackEl.textContent = data.message || (modeEl.value === 'edit' ? 'Report updated.' : 'Report submitted.');
      // Close after a beat and refresh to reflect changes
      setTimeout(() => {
        const modal = bootstrap.Modal.getInstance(modalEl);
        modal.hide();
        window.location.reload();
      }, 700);
    } else {
      feedbackEl.classList.remove('text-success');
      feedbackEl.classList.add('text-danger');
      feedbackEl.textContent = data.message || 'Failed to process.';
    }
  } catch (err) {
    feedbackEl.classList.remove('d-none');
    feedbackEl.classList.add('text-danger');
    feedbackEl.textContent = 'Network error. Please try again.';
  } finally {
    submitBtnEl.disabled = false;
  }
});
</script>
