{# templates/report_button.html #}
{# Usage: {% include "reports/report_button.html" with obj=venue target_type="venue" %} #}
<button
  type="button"
  class="btn btn-link p-0 text-danger"
  data-open-report
  data-target-type="{{ target_type }}"
  data-object-id="{{ obj.pk }}"
  data-bs-toggle="modal"
  data-bs-target="#reportModal"
  title="Report this item"
>
  Report
</button>

<!-- templates/reports/report_modal.html -->
<div class="modal fade" id="reportModal" tabindex="-1" aria-labelledby="reportModalTitle" aria-hidden="true" data-bs-backdrop="static">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title" id="reportModalTitle">Report content</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <form id="reportForm" method="POST" action="{% url 'reports:create' %}">
        {% csrf_token %}

        <!-- mode + target -->
        <input type="hidden" id="report-mode" value="create"> <!-- 'create' or 'edit' -->
        <input type="hidden" name="object_id" id="report-object-id">
        <input type="hidden" name="target_type" id="report-target-type">

        <div class="modal-body">
          <div class="mb-3">
            <label for="report-reason" class="form-label">Reason</label>
            <select name="reason" id="report-reason" required class="form-select">
              <option value="inappropriate">Inappropriate / Harassment</option>
              <option value="spam">Spam / Ads</option>
              <option value="false_info">False or Misleading Info</option>
              <option value="scam">Scam / Fraud</option>
              <option value="other">Other</option>
            </select>
          </div>

          <div class="mb-3">
            <label for="report-details" class="form-label">Details (optional)</label>
            <textarea name="details" id="report-details" rows="4" class="form-control" placeholder="Add context or evidence..."></textarea>
          </div>

          <p id="reportFeedback" class="small d-none mb-0"></p>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary" id="reportSubmitBtn">Submit</button>
        </div>
      </form>

    </div>
  </div>
</div>

<script>
(() => {
  // Global guard: if this script is included twice, bail out on the second run
  if (window.__reportModalInit) return;
  window.__reportModalInit = true;

  document.addEventListener('DOMContentLoaded', () => {
    const modalEl = document.getElementById('reportModal');
    if (!modalEl) return;

    const formEl       = document.getElementById('reportForm');
    const feedbackEl   = document.getElementById('reportFeedback');
    const submitBtnEl  = document.getElementById('reportSubmitBtn');
    const modeEl       = document.getElementById('report-mode');
    const titleEl      = document.getElementById('reportModalTitle');
    const objectIdEl   = document.getElementById('report-object-id');
    const targetTypeEl = document.getElementById('report-target-type');
    const reasonEl     = document.getElementById('report-reason');
    const detailsEl    = document.getElementById('report-details');

    // Per-element guard: never bind twice even if DOMContentLoaded fires again (rare)
    if (formEl.dataset.bound === '1') return;
    formEl.dataset.bound = '1';

    // CSRF helpers
    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return decodeURIComponent(parts.pop().split(';').shift());
    }
    function getCsrfToken() {
      const input = formEl.querySelector('input[name="csrfmiddlewaretoken"]');
      return (input && input.value) || getCookie('csrftoken') || '';
    }

    // Fill modal on open
    modalEl.addEventListener('show.bs.modal', (evt) => {
      const btn = evt.relatedTarget;
      if (!btn) return;

      objectIdEl.value   = btn.dataset.objectId || '';
      targetTypeEl.value = btn.dataset.targetType || '';
      feedbackEl.classList.add('d-none');
      feedbackEl.classList.remove('text-danger', 'text-success');
      feedbackEl.textContent = '';

      if (btn.hasAttribute('data-edit-report')) {
        modeEl.value = 'edit';
        titleEl.textContent = 'Edit your report';
        formEl.action = btn.dataset.reportAction || formEl.action;
        reasonEl.value  = btn.dataset.reportReason || 'inappropriate';
        detailsEl.value = btn.dataset.reportDetails || '';
        submitBtnEl.textContent = 'Save Changes';
      } else {
        modeEl.value = 'create';
        titleEl.textContent = 'Report content';
        // reset fields (don’t call form.reset() here to preserve csrf token)
        reasonEl.value  = 'inappropriate';
        detailsEl.value = '';
        submitBtnEl.textContent = 'Submit';
      }
    });

    // Reset when closed
    modalEl.addEventListener('hidden.bs.modal', () => {
      // Keep CSRF field intact; reset only user fields
      reasonEl.value  = 'inappropriate';
      detailsEl.value = '';
      feedbackEl.classList.add('d-none');
      feedbackEl.classList.remove('text-danger', 'text-success');
      feedbackEl.textContent = '';
      submitBtnEl.disabled = false;
      submitting = false; // allow next submission after close
    });

    // Prevent double-submit + overlapping writes
    let submitting = false;

    formEl.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (submitting) return;              // guard 1: ignore second click
      submitting = true;

      submitBtnEl.disabled = true;

      const fd = new FormData(formEl);

      try {
        const res = await fetch(formEl.action, {
          method: 'POST',
          headers: {
            'X-CSRFToken': getCsrfToken(),
            'X-Requested-With': 'XMLHttpRequest',
          },
          body: fd,                         // let browser set multipart/form-data
          credentials: 'same-origin',
        });

        let data;
        try { data = await res.json(); }
        catch { data = { ok: false, message: await res.text() }; }

        feedbackEl.classList.remove('d-none', 'text-success', 'text-danger');

        if (res.ok && data.ok) {
          feedbackEl.classList.add('text-success');
          feedbackEl.textContent = data.message || (modeEl.value === 'edit' ? 'Report updated.' : 'Report submitted.');
          setTimeout(() => {
            const inst = bootstrap.Modal.getOrCreateInstance(modalEl);
            inst.hide();
            // Reload to reflect the new/updated report list
            window.location.reload();
          }, 650);
          return;
        }

        // Error branch
        feedbackEl.classList.add('text-danger');
        const msg = data.errors
          ? JSON.stringify(data.errors)
          : (data.message || 'Failed to process.');
        feedbackEl.textContent = msg;

        // If backend returns existing_id on 409, surface a link
        if (res.status === 409 && data.existing_id) {
          const a = document.createElement('a');
          a.href = `/report/my/?focus=${data.existing_id}`;
          a.className = 'ms-1';
          a.textContent = 'View existing report';
          feedbackEl.appendChild(a);
        }

      } catch (err) {
        console.error('Network error:', err);
        feedbackEl.classList.remove('d-none', 'text-success');
        feedbackEl.classList.add('text-danger');
        feedbackEl.textContent = 'Network error. Please try again.';
      } finally {
        // Keep disabled briefly to avoid frantic re-clicks; re-enable only on error
        if (feedbackEl.classList.contains('text-danger')) {
          submitBtnEl.disabled = false;
          submitting = false; // allow retry on error only
        }
      }
    }, { once: true }); // guard 2: browser won’t add this listener again
  });
})();
</script>
