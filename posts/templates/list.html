{% extends "base.html" %}
{% load static %}

{% block meta %}
<title>Posts</title>
<style>
  .feed-wrap{max-width:920px;margin:0 auto}
  .composer{background:#fff;border:1px solid #e6e6e6;border-radius:.75rem;box-shadow:0 2px 8px rgba(0,0,0,.03)}
  .composer textarea{resize:vertical; min-height:110px}
  .avatar{width:44px;height:44px;border-radius:50%;background:#e9ecef;display:inline-block}
  .post-card{border:1px solid #e6e6e6;border-radius:.75rem;background:#fff}
  .post-card:hover{box-shadow:0 10px 20px rgba(0,0,0,.04)}
  .post-actions .btn{padding:0 .4rem}
  .muted{color:#6c757d}
</style>
{% endblock meta %}

{% block content %}
<div class="container py-4 feed-wrap">

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="fw-bold mb-0">Posts</h3>

    <form class="d-flex" method="get" action="{% url 'posts:list' %}">
      <input class="form-control me-2" type="search" name="q" value="{{ q }}" placeholder="Search text or venue…">
      <button class="btn btn-success">Search</button>
      {% if q %}
        <a href="{% url 'posts:list' %}" class="btn btn-outline-secondary ms-2">Clear</a>
      {% endif %}
    </form>
  </div>

  <div class="composer p-3 mb-4">
    <form id="create-form" method="post" action="{% url 'posts:api_create' %}">
      {% csrf_token %}
      <div class="d-flex gap-3">
        <span class="avatar"></span>
        <div class="flex-grow-1">
          <textarea class="form-control" name="content" placeholder="What's happening?" maxlength="500" required></textarea>
          <div class="row mt-2 g-2">
            <div class="col-12 col-sm-6">
              <input class="form-control" name="venue_hint" placeholder="Optional: venue (e.g., GBK)">
            </div>
            <div class="col-12 col-sm-6 text-sm-end text-start">
              <small class="muted">Tip: “Looking for 1 more at GBK”, “Great session tonight!”</small>
            </div>
          </div>
          <div class="d-flex justify-content-end mt-3">
            <button class="btn btn-success px-4" id="post-btn" type="submit">Post</button>
          </div>
        </div>
      </div>
    </form>
  </div>

  <div id="feed">
    {% if page_obj.object_list %}
      {% for p in page_obj.object_list %}
        {% include "partials/card.html" with p=p %}
      {% endfor %}
    {% else %}
      <p id="feed-empty" class="muted">No posts yet.</p>
    {% endif %}
  </div>

  {% if page_obj.paginator.num_pages > 1 %}
  <nav class="mt-3">
    <ul class="pagination">
      {% if page_obj.has_previous %}
        <li class="page-item">
          <a class="page-link"
             href="{% url 'posts:list' %}{% if q %}?q={{ q }}&{% else %}?{% endif %}page={{ page_obj.previous_page_number }}">
            Previous
          </a>
        </li>
      {% endif %}

      <li class="page-item disabled">
        <span class="page-link">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
      </li>

      {% if page_obj.has_next %}
        <li class="page-item">
          <a class="page-link"
             href="{% url 'posts:list' %}{% if q %}?q={{ q }}&{% else %}?{% endif %}page={{ page_obj.next_page_number }}">
            Next
          </a>
        </li>
      {% endif %}
    </ul>
  </nav>
  {% endif %}
</div>

<script src="{% static 'posts/posts.js' %}?v=5" defer></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const form = document.getElementById('create-form');
  if (!form) return;
  if (form.dataset.boundInline) return;        

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    const res = await fetch(form.action, {
      method: 'POST',
      headers: { 'X-CSRFToken': csrftoken },
      body: new FormData(form)
    });
    const data = await res.json().catch(() => ({}));
    if (res.ok && data.html) {
      const feed = document.getElementById('feed');
      document.getElementById('feed-empty')?.remove();
      const tpl = document.createElement('template');
      tpl.innerHTML = data.html.trim();
      feed.prepend(tpl.content.firstElementChild);
      form.reset();
    } else {
      alert('Failed to create post.');
    }
  });
});
</script>
{% endblock content %}
